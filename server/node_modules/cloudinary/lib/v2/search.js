const api = require('./api');
const { isEmpty, isNumber } = require('../utils');

const Search = class Search {
  constructor() {
    this.query_hash = {
      sort_by: [],
      aggregate: [],
      with_field: [],
<<<<<<< HEAD
=======
      fields: []
>>>>>>> master
    };
  }

  static instance() {
    return new Search();
  }

  static expression(value) {
    return this.instance().expression(value);
  }

  static max_results(value) {
    return this.instance().max_results(value);
  }

  static next_cursor(value) {
    return this.instance().next_cursor(value);
  }

  static aggregate(value) {
    return this.instance().aggregate(value);
  }

  static with_field(value) {
    return this.instance().with_field(value);
  }

  static fields(value) {
    return this.instance().fields(value);
  }

  static sort_by(field_name, dir = 'asc') {
    return this.instance().sort_by(field_name, dir);
  }

<<<<<<< HEAD
=======
  static ttl(newTtl) {
    return this.instance().ttl(newTtl);
  }

  static execute(options, callback) {
    return this.instance().execute(options, callback);
  }

>>>>>>> master
  expression(value) {
    this.query_hash.expression = value;
    return this;
  }

  max_results(value) {
    this.query_hash.max_results = value;
    return this;
  }

  next_cursor(value) {
    this.query_hash.next_cursor = value;
    return this;
  }

  aggregate(value) {
    this.query_hash.aggregate.push(value);
    return this;
  }

  with_field(value) {
<<<<<<< HEAD
    this.query_hash.with_field.push(value);
=======
    if (Array.isArray(value)) {
      this.query_hash.with_field = this.query_hash.with_field.concat(value);
    } else {
      this.query_hash.with_field.push(value);
    }

    this.query_hash.with_field = Array.from(new Set(this.query_hash.with_field));
    return this;
  }

  fields(value) {
    if (Array.isArray(value)) {
      this.query_hash.fields = this.query_hash.fields.concat(value);
    } else {
      this.query_hash.fields.push(value);
    }

    this.query_hash.fields = Array.from(new Set(this.query_hash.fields));
>>>>>>> master
    return this;
  }

  sort_by(field_name, dir = "desc") {
    let sort_bucket;
    sort_bucket = {};
    sort_bucket[field_name] = dir;
    this.query_hash.sort_by.push(sort_bucket);
    return this;
  }

  to_query() {
    Object.keys(this.query_hash).forEach((k) => {
      let v = this.query_hash[k];
      if (!isNumber(v) && isEmpty(v)) {
        delete this.query_hash[k];
      }
    });
    return this.query_hash;
  }

  execute(options, callback) {
    if (callback === null) {
      callback = options;
    }
    options = options || {};
    return api.search(this.to_query(), options, callback);
  }
};

module.exports = Search;
